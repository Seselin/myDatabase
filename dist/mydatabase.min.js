/*! mydatabase - v1.0.0 - 2015-11-21
* https://github.com/shipeifei/myDatabase#readme
* Copyright (c) 2015 shipeifei; Licensed  */
!function(a,b,c){function d(a,b,c,d){this.defaultConfig={dataName:"myDatabase",version:"1.0",description:"this is myDatabase",size:2097152},this.dataName=a||this.defaultConfig.dataName,this.description=c||this.defaultConfig.description,this.version=b||this.defaultConfig.version,this.size=d||this.defaultConfig.size,this.initData()}var e=Array.prototype,f=Object.prototype,g=Function.prototype,h=(e.push,e.slice,f.toString),i=(f.hasOwnProperty,Array.isArray,Object.keys,g.bind,Object.create,function(){var b={};b.isUseDatabase=a.openDatabase?!0:!1,b.extend=function(a,b){for(var c in b)a[c]=b[c]},b.getTime=Date.now||function(){return(new Date).getTime()},b.lowercaseFirst=function(a){return a[0].toLowerCase()+a.slice(1)},b.uppercaseFirst=function(a){return a[0].toUpperCase()+a.slice(1)},Date.prototype.format=function(a){var b={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":c.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var d in b)new RegExp("("+d+")").test(a)&&(a=a.replace(RegExp.$1,1===RegExp.$1.length?b[d]:("00"+b[d]).substr((""+b[d]).length)));return a},b.isObject=function(a){var b=typeof a;return"function"===b||"object"===b&&!!a},b.isFunction=function(a){return!!(a&&a.constructor&&a.call&&a.apply)};var d=["Arguments","String","Number","Date","RegExp"];return d.forEach(function(a){b["is"+a]=function(b){return h.call(b)==="[object "+a+"]"}}),b.isBoolean=function(a){return a===!0||a===!1||"[object Boolean]"===h.call(a)},b._isNull=function(a){return null===a},b.isUndefined=function(a){return void 0===a},b.isUndef=function(a){return void 0===a},b.lTrim=function(a){var b;for(b=0;b<a.length&&(" "===a.charAt(b)||" "===a.charAt(b));b++);return a=a.substring(b,a.length)},b.rTrim=function(a){var b;for(b=a.length-1;b>=0&&(" "===a.charAt(b)||" "===a.charAt(b));b--);return a=a.substring(0,b+1)},b.trim=function(a){return this.lTrim(this.rTrim(a))},b.isNull=function(a){return null===a},b.each=function(a,b){for(var c in a)b(a[c],c)},b.placeholder=function(){return"?"},b.format=function(a){var b=arguments;return a.replace(/{(\d+)}/g,function(a,c){var d=parseInt(c,10);return isFinite(d)?b[1+d]:a})},b}()),j=j||{};!function(){var a=j,b=/^(\d{4}|\+\d{6})(?:-(\d{2})(?:-(\d{2})(?:T(\d{2}):(\d{2}):(\d{2})\.(\d{1,3})(?:Z|([\-+])(\d{2}):(\d{2}))?)?)?)?$/;a.cs={pk:"pk",text:"text",integer:"int",numeric:"numeric",decimal:"decimal",date:"date",bool:"boolean",rowset:"rowset",row:"row",scalar:"scalar",nonQuery:"non-query",insert:"insert",update:"update",any:"any"},a.translateType=function(a){var b=a;switch(a){case"pk":b="INTEGER PRIMARY KEY  AUTOINCREMENT";break;case"int":b="INTEGER";break;case"decimal":b="numeric";break;case"date":b="datetime";break;case"text":b="text";break;case"boolean":b="boolean"}return b},a.inferQueryType=function(b){var c=b.toLowerCase();return 0===c.indexOf("insert")?a.cs.insert:0===c.indexOf("select")?c.indexOf("limit(1)")>0?a.cs.row:a.cs.rowset:0===c.indexOf("update")||0===c.indexOf("delete")?a.cs.nonQuery:a.cs.any},this.processRow=function(a){var c={};for(var d in a){var e=a[d];if(i.isString(e)&&e.match(b)){var f=Date.parse(e);f&&(e=new Date(f))}c[d]=e}return c},a.processResultType=function(b,c){switch(c){case a.cs.any:return b;case a.cs.insert:return b.insertId;case a.cs.rowset:var d,e=b.rows.length,f=[];for(d=0;e>d;d++){var g=a.processRow(b.rows.item(d));f.push(g)}return f;case a.cs.row:return b.rows.length?a.processRow(b.rows.item(0)):null;case a.cs.scalar:if(b.rows.length){var h=a.processRow(b.rows.item(0));for(var i in h)return h[i]}return null;case a.cs.nonQuery:return b.rowsAffected;default:return b}},a.typeToDb=function(a){return i.isDate(a)?a.toISOString():i.isBoolean(a)?a?1:0:a}}(),d.dataType={pk:"pk",text:"text",integer:"int",numeric:"numeric",decimal:"decimal",date:"date",bool:"boolean"},d.prototype={bug:!1,tableSQL:"SELECT name FROM sqlite_master   WHERE type='table' ORDER BY name",operationsMap:{"=":"=","!":"!=",">":">","<":"<",">=":">=","<=":"<=","!=":"<>","<>":"<>"},myDB:openDatabase(this.dataName,this.version,this.description,this.size),dbLog:function(a){this.isdebug&&console.log(a)},initData:function(){return i.isNull(this.dataName)?(alert("建议您最好添加自己的数据库名称，防止冲突!!"),!1):i.isUseDatabase?(this.dbLog("初始化数据库失败!!"),void(this.myDB?this.dbLog("初始化数据成功!!"):this.dbLog("初始化数据库失败!!"))):(alert("您当前的浏览器不支持HTML5，建议您升级为当前浏览器的最新版本!!"),!1)},execSql:function(a,b,c){var d=b?b.map(j.typeToDb):b;this.myDB.transaction(function(b){b.executeSql(a,d,function(a,b){return i.isFunction(c)&&c(!0,a,b),!0},function(a,b){return i.isFunction(c)&&c(!1,a,b),console.log(b),!1})})},_createColumn:function(a,b){return i.isString(b)?a+" "+j.translateType(b):a+" "+j.translateType(b.type)+(b.required?" NOT NULL":"")+(b.unique?" UNIQUE":"")},createTable:function(a,b,c){var d="CREATE TABLE "+(c?"IF NOT EXISTS ":"")+a+"(",e=[];e.push(this._createColumn("id","pk"));for(var f in b)"timestamps"===f?(e.push("created_at int"),e.push("updated_at int")):"id"!==f&&e.push(this._createColumn(f,b[f]));d+=e.join(", ")+")",this.dbLog("创建table的语句为："+d),this.execSql(d,[],function(b,c,d){b?console.log(d):console.log("创建表:"+a+"失败,"+d.message)})},addColumn:function(a,b,c){var d="ALTER TABLE "+a+" ADD COLUMN "+this._createColumn(b,c);this.dbLog(d),this.execSql(d,[],function(b,c,d){b?console.log(d):console.log("增加表:"+a+"失败,"+d.message)})},define:function(a,b){this.createTable(a,b,!0)},defineMutile:function(a){if(i.isUndefined(a))return console.log("参数不正确"),!1;this.define;if(Array.isArray(a))for(var b in a)this.define(a[b].table,a[b].properties);else console.log("参数只支持数组格式:[{table: 'foo',properties: {task: {type: 'text',required: true},duedate: 'date'}}]")},dropTable:function(a){var b="DROP TABLE IF EXISTS "+a;this.execSql(b,[],function(b,c,d){b?console.log(d):console.log("删除表:"+a+"失败,"+d.message)})},nonQuery:function(a,b,c){},"delete":function(a,b,c){var d=" delete from "+a;i.isString(b)&&(d+=" where "+b),d+=this.where(b),this.execSql(d,[],c)},update:function(a,b,c,d){if(!c)throw"update should be called with conditions";if(!b)throw"update should be called with columns";if(!i.isObject(b))throw"fields 必须是json对象类型";var e=[],f=[],g=0;for(var h in b)e.push(h+" = "+i.placeholder(++g)),f.push(b[h]);var j=i.format("update {0} set {1}",a,e.join(","));i.isString(c)&&(j+=" where "+c),j+=this.where(c),console.log("修改sql语句 :"+j),this.execSql(j,f,d)},where:function(a){var b="",c=this.operationsMap;return i.isNull(a)||i.isUndef(a)||""===a?"":function(){if(i.isObject(a)){var d=[];for(var e in a){var f=i.trim(e).split(/ +/),g=f[0],h=c[f[1]]||"=";d.push(g+" "+h+"'"+a[e]+"'")}b+=" where "+d.join(" and ")}return i.isString(a)&&(b+=" where "+a),console.log(b),b}()},order:function(a){if(i._isNull(a)||i.isUndef(a))return"";if(i.isString(a))return" ORDER BY "+a;if(i.isObject(a)){var b=" ORDER BY ",c="";for(var d in a)c+=", "+d+" "+a[d];return this.dbLog(b+c.substr(1)),b+c.substr(1)}},page:function(a,b){return i.isUndef(a)?"":i.isUndef(b)?" LIMIT "+a:" LIMIT "+a+" OFFSET "+b},insert:function(a,b,c){if(!b)throw"insert should be called with parames";var d=i.format("INSERT INTO {0} ({1}) VALUES(",a,Object.keys(b).join(", ")),e=[],f=[],g=0;for(var h in b)f.push(i.placeholder(++g)),e.push(b[h]);d+=f.join(", ")+")",this.execSql(d,e,c)},insertMutile:function(a,b,c){if(i.isUndefined(b))return console.log("参数不正确"),!1;if(Array.isArray(b))for(var d in b)this.insert(a,b[d],c);else console.log("参数只支持数组格式:[{name:'shipefei',password:'123456'},{name:'shipefei',password:'123456'}]")},query:function(){this.execSql("select * from todo",[],function(a,b,c){a?console.log(c):console.log(error)})},myQuery:function(a,b,c,d,e,f,g){var h=" select ";return i._isNull(a)||i.isUndef(a)?(this.dbLog("请输入数据库名称"),!1):(h+=i.isUndef(b)||i._isNull(b)?" * ":(i.isString(b)?b:b.join(","))+" from "+a,h+=this.where(c),h+=this.order(d),h+=this.page(f,e),this.dbLog(h),void this.execSql(h,[],g))},queryOne:function(a,b,c){this.dbLog(a+"参数:"+b.join(",")),this.execSql(a,b,c)},all:function(a,b,c){var d="select ";d+=i.isString(b)?b:(1===b.length?b[0]:b.join(" , "))+" from "+a,this.dbLog(d),this.execSql(d,[],c)}},"undefined"!=typeof module&&module.exports?module.exports=d:a.myDatabase=d}(window,document,Math);